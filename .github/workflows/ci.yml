name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    runs-on: macos-26
    env:
      DEVELOPER_DIR: /Applications/Xcode_26.2.app/Contents/Developer
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Generate Xcode project
        run: xcodegen generate

      - name: Resolve packages
        run: |
          xcodebuild -resolvePackageDependencies \
            -project Listacular.xcodeproj \
            -scheme Listacular \
            -quiet

      - name: Boot simulator
        run: |
          DEVICE_ID=$(xcrun simctl list devices available -j | python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          for runtime, devices in data['devices'].items():
              for d in devices:
                  if d['name'] == 'iPhone 17 Pro' and d['isAvailable']:
                      print(d['udid'])
                      sys.exit(0)
          ")
          xcrun simctl boot "$DEVICE_ID" || true

      - name: Build
        run: |
          xcodebuild build \
            -project Listacular.xcodeproj \
            -scheme Listacular \
            -destination "platform=iOS Simulator,name=iPhone 17 Pro" \
            -quiet

      - name: Run unit tests
        run: |
          xcodebuild test \
            -project Listacular.xcodeproj \
            -scheme ListacularTests \
            -destination "platform=iOS Simulator,name=iPhone 17 Pro" \
            -resultBundlePath TestResults/unit-tests.xcresult \
            2>&1 | tee test-output.log
          # Show summary even on success
          grep -E '(✔|✘|Test run|passed|failed)' test-output.log || true

      - name: Run snapshot tests
        # Snapshot reference images are architecture-specific. Re-record on CI
        # by setting SNAPSHOT_TESTING_RECORD=1 if snapshots fail due to
        # rendering differences between local and CI hardware.
        run: |
          xcodebuild test \
            -project Listacular.xcodeproj \
            -scheme ListacularSnapshotTests \
            -destination "platform=iOS Simulator,name=iPhone 17 Pro" \
            -resultBundlePath TestResults/snapshot-tests.xcresult \
            2>&1 | tee snapshot-output.log
          grep -E '(✔|✘|Test run|passed|failed)' snapshot-output.log || true

      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: TestResults/
          retention-days: 7
